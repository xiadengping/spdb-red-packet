{"version":3,"sources":["../src/wechat.js"],"names":["debug","process","on","console","log","err","Wechat","extend","state","CONF","STATE","init","contacts","Contact","Message","lastReportTime","syncErrorCount","callback","syncCheck","then","selector","SYNCCHECK_SELECTOR_NORMAL","sync","data","syncPolling","Date","notifyMobile","user","UserName","catch","sendText","toLocaleString","emit","logout","setTimeout","ret","undefined","getUUID","uuid","checkLogin","code","userAvatar","login","getContact","length","updateContacts","handleSync","AddMsgCount","handleMsg","AddMsgList","ModContactCount","ModContactList","forEach","Promise","resolve","msg","FromUserName","batchGetContact","MsgType","MSGTYPE_STATUSNOTIFY","userList","StatusNotifyUserName","split","map","all","chunk","list","res","contact","original","__proto__","i","Object","assign","members","key","member","push","username","nickname","getDisplayName","py","avatar","AvatarUrl","exports","module"],"mappings":"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","file":"wechat.js","sourcesContent":["import WechatCore from './core'\nimport EventEmitter from 'events'\n\nimport _ from 'lodash'\nimport {\n  getCONF,\n  isStandardBrowserEnv\n} from './util'\n\nimport ContactFactory from './interface/contact'\nimport MessageFactory from './interface/message'\n\nimport _debug from 'debug'\nconst debug = _debug('wechat')\n\nif (!isStandardBrowserEnv) {\n  process.on('uncaughtException', err => {\n    console.log('uncaughtException', err)\n  })\n}\n\nclass Wechat extends WechatCore {\n\n  constructor() {\n    super()\n    _.extend(this, new EventEmitter())\n    this.state = this.CONF.STATE.init\n    this.contacts = {} // 所有联系人\n    this.Contact = ContactFactory(this)\n    this.Message = MessageFactory(this)\n    this.lastReportTime = 0\n    this.syncErrorCount = 0\n  }\n\n  get friendList() {\n    let members = []\n\n    for (let key in this.contacts) {\n      let member = this.contacts[key]\n      members.push({\n        username: member['UserName'],\n        nickname: this.Contact.getDisplayName(member),\n        py: member['RemarkPYQuanPin'] ? member['RemarkPYQuanPin'] : member['PYQuanPin'],\n        avatar: member.AvatarUrl\n      })\n    }\n\n    return members\n  }\n\n  syncPolling(callback) {\n    this.syncCheck().then(selector => {\n      debug('Sync Check Selector: ', selector)\n      if (selector != this.CONF.SYNCCHECK_SELECTOR_NORMAL) {\n        return this.sync().then(data => {\n          this.syncErrorCount = 0\n          callback(data)\n        })\n      }\n    }).then(() => {\n      this.syncPolling(callback)\n      if (+new Date() - this.lastReportTime > 5 * 60 * 1000) {\n        debug('Status Report')\n        this.notifyMobile(this.user.UserName)\n          .catch(debug)\n        this.sendText('心跳：' + new Date().toLocaleString(), 'filehelper')\n          .catch(debug)\n        this.lastReportTime = +new Date()\n      }\n    }).catch(err => {\n      this.emit('error', err)\n      if (this.syncErrorCount++ > 5) {\n        debug(err)\n        this.logout()\n        callback()\n      } else {\n        setTimeout(() => {\n          this.syncPolling(callback)\n        }, 1000 * this.syncErrorCount)\n      }\n    })\n  }\n\n  async start() {\n    let ret = undefined\n    try {\n      ret = await this.getUUID()\n      debug('getUUID: ', ret)\n      this.emit('uuid', ret)\n      this.state = this.CONF.STATE.uuid\n      do {\n        ret = await this.checkLogin()\n        debug('checkLogin: ', ret)\n        if (ret.code == 201 && ret.userAvatar) {\n          this.emit('user-avatar', ret.userAvatar)\n        }\n      } while (ret.code !== 200)\n      await this.login()\n      await this.init()\n      await this.notifyMobile()\n      ret = await this.getContact()\n      debug('getContact data length: ', ret.length)\n      this.updateContacts(ret)\n    } catch (err) {\n      this.emit('error', err)\n      debug(err)\n      this.logout()\n      this.state = this.CONF.STATE.logout\n      return\n    }\n    this.syncPolling(data => this.handleSync(data))\n    this.emit('login')\n    this.state = this.CONF.STATE.login\n  }\n\n  stop() {\n    this.logout()\n  }\n\n  handleSync(data) {\n    if (!data) {\n      this.emit('logout')\n      this.state = this.CONF.STATE.logout\n      return\n    }\n    if (data.AddMsgCount) {\n      debug('syncPolling messages count: ', data.AddMsgCount)\n      this.handleMsg(data.AddMsgList)\n    }\n    if (data.ModContactCount) {\n      debug('syncPolling ModContactList count: ', data.ModContactCount)\n      this.updateContacts(data.ModContactList)\n    }\n  }\n\n  handleMsg(data) {\n    data.forEach(msg => {\n      Promise.resolve().then(() => {\n        if (!this.contacts[msg.FromUserName]) {\n          return this.batchGetContact([{\n            UserName: msg.FromUserName\n          }]).catch(err => {\n            debug(err)\n            return [{\n              UserName: msg.FromUserName\n            }]\n          }).then(contacts => {\n            this.updateContacts(contacts)\n          })\n        }\n      }).then(() => {\n        msg = this.Message.extend(msg)\n        this.emit('message', msg)\n        if (msg.MsgType == this.CONF.MSGTYPE_STATUSNOTIFY) {\n          let userList = msg.StatusNotifyUserName.split(',').map(UserName => {\n            return {\n              UserName: UserName\n            }\n          })\n          Promise.all(_.chunk(userList, 50).map(list => {\n            return this.batchGetContact(list).then(res => {\n              debug('batchGetContact data length: ', res.length)\n              this.updateContacts(res)\n            })\n          })).catch(err => {\n            debug(err)\n          })\n        }\n      }).catch(err => {\n        this.emit('error', err)\n        debug(err)\n      })\n    })\n  }\n\n  updateContacts(contacts) {\n    contacts.forEach(contact => {\n      if (this.contacts[contact.UserName]) {\n        let original = this.contacts[contact.UserName].__proto__\n        for (let i in contact) {\n          contact[i] || delete contact[i]\n        }\n        Object.assign(original, contact)\n        this.contacts[contact.UserName].init(this)\n      } else {\n        this.contacts[contact.UserName] = this.Contact.extend(contact)\n      }\n    })\n    this.emit('contacts-updated', contacts)\n  }\n}\n\nWechat.STATE = getCONF().STATE\n\nexports = module.exports = Wechat\n"]}